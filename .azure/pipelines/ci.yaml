#
# ### Build + Deploy to Production (CD)
#
# The Continuous Deployment template (CD.yaml) builds the code
# and deploys it to the production environment. 
#
# Currently, this runs for every new commit to main branch. In
# the future, it will be triggered by new tags only.
#
# REQUIRED PIPELINE VARIABLES:
# These must be set as pipeline-specific variables in the pipeline settings.
# - azureAppServiceName: Name of the Azure App Service for backend deployment
# - azureStaticAppApiToken: API token for Azure Static Web Apps deployment
# - azureServiceConnectionName: Service connection to use for backend deployment
# - backendBaseUrl: Base URL of the deployed backend service
# - dockerRegistryEndpoint: Service connection for Docker registry
# - dockerUserName: Docker registry user name
# 

trigger:
  branches:
    include:
    - main

pr: none

variables:
- template: vars/vars-all.yaml
- template: vars/vars-ci.yaml

#
# Build & Test Stage
#

stages:
- stage: BuildTestPublishStage
  displayName: 'Build, Test & Publish Artifacts'

  jobs:
  - job: BuildTestPublish
    displayName: 'Build+Test+Publish'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: steps/git-checkout-self.yaml
    - template: steps/use-dotnet-sdk.yaml
      parameters:
        version: '10.x'
    - template: steps/build-solution.yaml
    - template: steps/run-tests.yaml
    - template: steps/build-nuxt.yaml
    - template: steps/publish-functional-script.yaml
    - template: steps/publish-nuxt.yaml
    - template: steps/publish-web-archive.yaml

#
# Containerize & Functional Test Stage
#

- stage: ContainerizeFunctionalStage
  displayName: 'Containerize & Run Functional Tests'
  dependsOn: BuildTestPublishStage
  condition: succeeded()

  jobs:
  - job: ContainerizeFunctional
    displayName: 'Containerize+Functional'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: steps/git-checkout-self.yaml
    - template: steps/docker-compose-build.yaml
    - template: steps/docker-compose-up.yaml
    - template: steps/use-dotnet-sdk.yaml
      parameters:
        version: '10.x'
    - template: steps/build-functional-tests.yaml
    - template: steps/run-functional-tests.yaml
    # TODO: - template: steps/docker-compose-push.yaml

#
# Deploy to Azure Stage
#

- stage: DeployStage
  displayName: 'Deploy to Azure'
  dependsOn: ContainerizeFunctionalStage
  condition: succeeded()

  jobs:
  - job: DeployStaticWebApp
    displayName: 'Deploy to Azure Static Web App'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: steps/deploy-static.yaml

  - job: DeployAppService
    displayName: 'Deploy to Azure App Service'
    pool:
      vmImage: 'ubuntu-latest'

    steps:
    - template: steps/deploy-app-service.yaml

#
# TODO: Functional test against the deployed instance
#

