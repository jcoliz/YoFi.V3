# 0007. Proxy to backend or make direct calls?

Date: 2025-11-11

## Status

Accepted

## Context

### Question

Should we use Azure Static Web Apps [linked backend](https://learn.microsoft.com/en-us/azure/static-web-apps/apis-app-service) feature, or directly call the backend from JS running in browser?

### Background

As documented in [ADR 0006](./0006-production-infrastructure.md), I'm planning to use Azure Static Web Apps for the frontend and Azure App Service for the backend.

## Decision

We will call the backend directly from the frontend JS code.

## Consequences

What becomes easier or more difficult to do because of this change?

### Cost Savings

* **Azure Static Web Apps Free Tier**: Supports custom domains with HTTPS
* **Eliminates Standard tier** requirement (~$9/month savings)
* Standard tier was otherwise **only** needed for the managed backend integration feature

### Technical Advantages

* **CORS is straightforward**: Configure CORS in the .NET backend (`Program.cs`)
* **Better for static generation**: When we run `nuxt generate`, the site is truly static. No server-side proxying is needed.
* **Simpler architecture**: Frontend and backend are independently deployable
* **Better observability**: Direct calls make it easier to trace requests
* **CDN-friendly**: Static Web Apps CDN works optimally with static content

### Downsides

* The front-end container image is coupled to where the backend is hosted. This makes it less portable, and locks it into running exactly in the environment where the backend is running in the expected place.
* Backend CORS configuration must be environment-specific to prevent production backends from accepting requests from development clients. (This has been implemented - see Security & CORS Configuration section below.)
* We lose the "single URL" convenienceâ€”users see the backend API URL in network requests. However, this is a **minor** concern compared to the cost savings and architectural benefits.
* Rollback complexity: Frontend and backend versions become tightly coupled

### Implementation: FrontEnd Generation

We set `NUXT_PUBLIC_API_BASE_URL` environment variable **when generating** the static frontend content to point to the backend API URL. The frontend container dockerfile accepts an `ARG` for this.

The front-end is generated for only two environments. (See [ENVIRONMENTS.md](../ENVIRONMENTS.md) for a discussion of environments.)

* **Container**: In this environment, the frontend is built into a container. The only mechanism used to build it is to run `docker compose build` on the [docker-compose-ci.yml](../../docker/docker-compose-ci.yml) project. Here we control setting `NUXT_PUBLIC_API_BASE_URL`.
* **Production**: The frontend is generated by the Azure Pipelines [build-nuxt.yaml](../../.azure/pipelines/steps/build-nuxt.yaml) step. The pipeline sets `NUXT_PUBLIC_API_BASE_URL` using the `$(Backend.BaseUrl)` variable that points to the deployed production backend. The generated static site is then deployed via the [deploy-static.yaml](../../.azure/pipelines/steps/deploy-static.yaml) step.

### ðŸ”’ Security & CORS Configuration

CORS configuration is required to allow the frontend (running from Static Web Apps or nginx) to make direct API calls to the backend.

**Implementation:** CORS is now implemented via environment-specific configuration:

* [`ApplicationOptions.AllowedCorsOrigins`](../../src/Entities/Options/ApplicationOptions.cs) - Configuration property for allowed origins
* [`SetupCors.cs`](../../src/BackEnd/Setup/SetupCors.cs) - Configures CORS with explicit origins from configuration
* Development origins configured in [`appsettings.Development.json`](../../src/BackEnd/appsettings.Development.json) (e.g., `http://localhost:5173`)
* Production origins managed via Azure App Service configuration
* Logging ensures CORS is properly configured at startup

**Security considerations addressed:**
* No wildcard origins - all origins explicitly configured per environment
* Development backend only accepts local dev server origins
* Production backend only accepts Static Web Apps origin
* CORS preflight requests handled by ASP.NET Core middleware

### ðŸ“Š Monitoring & Observability

There are additional considerations to review in this area. However, I don't see these as strong enough to take a different direction. These are implementation details we will need to handle.

* Error handling: What happens when backend is unreachable?
* CORS failures: How will you we monitor and debug CORS issues in production?
* Client-side error reporting: Direct API calls mean client-side errors need proper telemetry

### ðŸ”„ Rollback Plan: How to handle deployment failures

There are questions to consider around the coupling of components.
However, I don't see a case where it affects this decision. If we
instead chose to proxy calls, we would still have these problems.

* What if one component deploys successfully, and the other fails?
* What if we need to roll the entire system back?

## Related Decisions

- [0006. Production Infrastructure](0006-production-infrastructure.md) - Production infrastructure context for this decision
