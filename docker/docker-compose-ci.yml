name: yofi-v3
services:
  dashboard:
    image: mcr.microsoft.com/dotnet/aspire-dashboard:13
    ports:
      - '18888:18888'  # Dashboard UI
      - '18889:18889'  # OTLP/gRPC endpoint
      - '18890:18890'  # OTLP/HTTP endpoint
    environment:
      - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    restart: unless-stopped
  frontend:
    image: ${REGISTRY_PREFIX:-}yofi-v3-frontend
    build:
      context: ../src/FrontEnd.Nuxt
      dockerfile: ./docker/Dockerfile
      args:
          # Set the API base URL for the frontend to point to the backend service, from the
          # perspective of JS code running in user's browser, *not* from the perspective of
          # within the container.
        - NUXT_PUBLIC_API_BASE_URL=http://localhost:5001
        - NUXT_PUBLIC_SOLUTION_VERSION=${SOLUTION_VERSION:-'docker-compose'}
        - NUXT_PUBLIC_APPLICATION_INSIGHTS_CONNECTION_STRING=${APPLICATIONINSIGHTS_CONNECTION_STRING:-}
    restart: always
    ports:
      - '5000:80'
    depends_on:
      backend:
        condition: service_healthy
  backend:
    image: ${REGISTRY_PREFIX:-}yofi-v3-backend
    build:
      context: ..
      dockerfile: ./docker/BackEnd.dockerfile
      args:
        - SOLUTION_VERSION=${SOLUTION_VERSION:-'docker-compose'}
    environment:
      - ASPNETCORE_ENVIRONMENT=Container
      - APPLICATION__ALLOWEDCORSORIGINS__0=http://localhost:5000
      - APPLICATION_INSIGHTS_CONNECTION_STRING=${APPLICATIONINSIGHTS_CONNECTION_STRING:-}
      - JWT__ISSUER=${JWT_ISSUER:-http://localhost:5001}
      - JWT__AUDIENCE=${JWT_AUDIENCE:-http://localhost:5001}
      # Warning: This key is for development / testing purposes only. Do not use in production!
      - JWT__KEY=${JWT_KEY:-YeO9WbjMjlalrCq5CpJEdBPFMevqfN4UtczfTtEmL14=}
      - JWT__LIFESPAN=${JWT_LIFESPAN:-00:10:00}
      - LOGGING__LOGLEVEL__YOFI=Debug
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire-dashboard:18889
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_SERVICE_NAME=yofi-backend
    restart: always
    ports:
      - '5001:8080'
    depends_on:
      - dashboard
  db:
    image: postgres:18.1-alpine
    restart: always
    environment:
      - POSTGRES_PASSWORD=development
      - POSTGRES_DB=db
      - POSTGRES_USER=postgres
      - PGUSER=postgres
    healthcheck:
      test: [ "CMD-SHELL" , "pg_isready" ]
      interval: 1s
      timeout: 5s
      retries: 10
  dbadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False      
    ports:
      - '5050:80'
    volumes:
      - ./pgadmin-servers.json:/pgadmin4/servers.json:ro
      - ./pgpass:/pgpass:ro
    depends_on:
      db:
        condition: service_healthy

# NOTE: It takes a while for pgadmin4 to become healthy. We don't want
# the backend service to wait that long, so we don't set a depends_on
# for it here. Instead, just make sure pgadmin4 is healthy before trying
# to use it.
#    healthcheck:
#      test: ["CMD", "wget", "-O", "-", "http://localhost:80/misc/ping"]
#      interval: 10s
#      timeout: 5s
#      retries: 5
